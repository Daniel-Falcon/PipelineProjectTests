trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self

  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  - script: |
      docker build -t cypress-vnc ./Docker
    displayName: 'Build custom Cypress + VNC Docker image'

  - script: |
      docker run -d --name cypress-vnc-run \
        -v $(pwd):/e2e \
        -w /e2e \
        -p 5901:5901 \
        cypress-vnc
    displayName: 'Run Cypress test inside Docker with VNC'

  - script: |
      docker logs cypress-vnc-run
    displayName: 'Show Docker logs (optional)'

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'cypress/videos'
      artifact: 'cypress-videos'
    condition: always()
    displayName: 'Publish Cypress test videos'
